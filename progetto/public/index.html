<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>McKinsey's ecosystem game solver – Demo & Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/styles.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <!-- correct file name (underscore) -->
  <script defer src="/public/js/calc_core.js"></script>
</head>
<body>
  <main class="container">
    <div class="row" style="align-items:center; justify-content:space-between; margin-bottom: 6px;">
      <h1>Ecosystem Game Solver</h1>
      <span class="badge" title="Demo does not consume attempts">Demo (k ≤ 3)</span>
    </div>
    <p class="muted">
      Try the demo (maximum subset size k = 3). If you like it, you can purchase the full solver.
      You'll receive your personal link via email and your attempts will be saved persistently.
      One attempt is consumed each time you click “Calculate”.
    </p>

    <section class="grid" style="margin-top:14px">
      <!-- DEMO (k ≤ 3, does not consume) -->
      <section class="card">
        <h2>Calculator demo</h2>

        <form id="form-add" onsubmit="return false;">
          <div class="row">
            <div class="grow">
              <label>Name</label>
              <input class="input" type="text" id="d-nome" placeholder="e.g. Eagle" />
            </div>
            <div style="width:180px">
              <label>Calories available</label>
              <input class="input" type="number" id="d-fondi" min="0" placeholder="120" />
            </div>
            <div style="width:180px">
              <label>Calories needed</label>
              <input class="input" type="number" id="d-bisogno" min="0" placeholder="200" />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label>Donors who can feed the animal (comma‑separated)</label>
              <input class="input" type="text" id="d-donatori" placeholder="Shark, Lion" />
            </div>
            <div class="grow">
              <label>Range 1 (optional, e.g. temperature)</label>
              <input class="input" type="text" id="d-range1" placeholder="1-5 or 3" />
            </div>
            <div class="grow">
              <label>Range 2 (optional)</label>
              <input class="input" type="text" id="d-range2" placeholder="10-20 or 12" />
            </div>
            <div class="grow">
              <label>Range 3 (optional)</label>
              <input class="input" type="text" id="d-range3" placeholder="2-4 or 3" />
            </div>
            <div class="grow">
              <label>Range 4 (optional)</label>
              <input class="input" type="text" id="d-range4" placeholder="5-8 or 6" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="d-add" type="button" class="btn">Add item</button>
            <button id="d-clear" type="button" class="btn btn-danger">Remove all</button>
          </div>
        </form>

        <table class="table">
          <thead>
            <tr>
              <th>Name</th><th>Calories</th><th>Required</th><th>Donors</th>
              <th>R1</th><th>R2</th><th>R3</th><th>R4</th><th></th>
            </tr>
          </thead>
          <tbody id="d-tbody"></tbody>
        </table>

        <div class="row" style="margin-top:10px; align-items: center;">
          <div style="width:260px; max-width: 100%;">
            <label>Subset k (max 3 — no limit in the full solver)</label>
            <input class="input" type="number" id="d-k" min="1" max="3" value="3" />
          </div>
          <button id="d-calc" type="button" class="btn">Calculate</button>
        </div>
        <pre id="d-result" class="result" style="margin-top:10px">Add some items and press Calculate.</pre>
        <p class="helper" style="margin-top:6px">
          The demo does not consume attempts and does not require a specific link.
          The developers of this solver have no affiliation with McKinsey & Company. Use this solver in accordance with McKinsey’s policies.
        </p>
      </section>

      <!-- PURCHASE -->
      <aside class="card">
        <h2>Purchase the full calculator</h2>
        <p class="helper">Link via email, persistent attempts, no limit on subset k.</p>
        <div class="divider"></div>
        <ul class="helper" style="list-style:none; padding:0; margin:0 0 6px">
          <li>1 attempt — €30</li>
          <li>3 attempts — €50</li>
          <li>10 attempts — €100</li>
        </ul>

        <form id="buy-form" onsubmit="return false;" style="margin-top:8px">
          <label>Email</label>
          <input class="input" type="email" id="email" placeholder="name@example.com" required />

          <label>Package</label>
          <select class="select" id="pkg" required>
            <option value="1">1 attempt (€30)</option>
            <option value="3">3 attempts (€50)</option>
            <option value="10">10 attempts (€100)</option>
          </select>
          <p class="helper" style="margin-top:6px">
            If you have a discount code, you’ll be able to enter it during checkout.
          </p>
          <p class="helper" style="margin-top:6px">
            It might be possible to pay in usd.
          </p>
          <p class="helper" style="margin-top:6px">
            For best efficiency we recommend buying multiple attemps and manually divide the animals in group of ranges in temperature/location etc.
          </p>

          <button id="btn-buy" type="button" class="btn" style="margin-top:10px; width:100%">Proceed to payment</button>
          <p id="msg" class="helper" style="margin-top:8px" aria-live="polite"></p>
        </form>
      </aside>
    </section>
    <!-- INSTRUCTIONS SECTION START -->
    <section class="card" style="margin:32px auto 0; max-width: 800px;">
      <h2>About the McKinsey Ecosystem Game & Solver Instructions</h2>
      <p>
        <strong>The McKinsey Ecosystem Game</strong> is a strategy simulation where participants manage interactions between various animals or agents in an ecosystem. Each animal has a set of needs (e.g., calories required) and resources (e.g., calories available) and may depend on other animals ("donors") to fulfill their needs. The goal is to find subsets of animals that can be sustainably matched so that everyone’s needs are met given the available resources and constraints (such as temperature, location, or other ranges).
      </p>
      <h3>How to Play:</h3>
      <ul>
        <li><strong>1. Add Items:</strong> Enter the name, calories available, calories needed, donors, and any additional range constraints for each animal or agent.</li>
        <li><strong>2. Set Subset Size k:</strong> Choose the maximum subset size k (in the demo, k ≤ 3). In the full version, you can use a higher k for more complex analysis.</li>
        <li><strong>3. Run Calculation:</strong> Press “Calculate” to let the solver find a valid subset and allocation for each animal. The tool will display which combinations satisfy all constraints and how resources can be distributed between donors and recipients.</li>
        <li><strong>4. Purchase Attempts:</strong> To access the full solver (no limit on k and persistent attempts), purchase attempts. You’ll receive a personal link via email, and each calculation consumes one attempt.</li>
      </ul>
      <h3>How the Calculator Works:</h3>
      <ul>
        <li>The calculator checks all possible subsets (up to k) and tries to allocate resources so that every animal’s needs are met by donors, respecting range constraints.</li>
        <li>If a valid subset is found, the result shows the allocation from each donor to recipient.</li>
        <li>If no valid subset exists, you’ll see “No valid subset found”.</li>
        <li>You can group animals manually or use the full solver to explore more complex combinations.</li>
      </ul>
      <h3>Tips:</h3>
      <ul>
        <li>Try various combinations to maximize ecosystem sustainability.</li>
        <li>Use range constraints to model temperature, location, or other factors.</li>
        <li>For best results, purchase multiple attempts and analyze different groupings.</li>
      </ul>
      <h3>Disclaimer:</h3>
      <p>
        This tool is an independent demo, not affiliated with McKinsey & Company. Please use in accordance with McKinsey’s policies and guidelines.
      </p>
    </section>
    <!-- INSTRUCTIONS SECTION END -->
  </main>

  <script>
    // ===== DEMO (does not consume; k ≤ 3) =====
    const D = { elementi: {}, norm: s=>String(s||"").trim().toLowerCase(), esc: s=>escapeHtml(s) };
    const fmtRange = (r) => formatRange(r);

    function renderDemoTable(){
      const tb = document.getElementById("d-tbody");
      tb.innerHTML = "";
      const entries = Object.entries(D.elementi);
      if(entries.length===0){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=9; td.textContent="No items."; td.className="helper";
        tr.appendChild(td); tb.appendChild(tr); return;
      }
      for(const [key,data] of entries){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${D.esc(data.displayName)}</td>
          <td>${data.fondi}</td>
          <td>${data.bisogno}</td>
          <td>${(data.possibili_donatori_display||[]).map(D.esc).join(", ")}</td>
          <td>${fmtRange(data.range1)}</td>
          <td>${fmtRange(data.range2)}</td>
          <td>${fmtRange(data.range3)}</td>
          <td>${fmtRange(data.range4)}</td>
          <td></td>`;
        const tdAz=tr.lastElementChild;
        const b=document.createElement("button");
        b.textContent="Remove";
        b.className="btn btn-danger";
        b.onclick=()=>{ delete D.elementi[key]; renderDemoTable(); };
        tdAz.appendChild(b);
        tb.appendChild(tr);
      }
    }

    document.getElementById("d-add").addEventListener("click", () => {
      const nomeRaw = document.getElementById("d-nome").value;
      const key = D.norm(nomeRaw);
      const fondi = parseInt((document.getElementById("d-fondi").value || "0"),10);
      const bisogno = parseInt((document.getElementById("d-bisogno").value || "0"),10);
      const donRaw = document.getElementById("d-donatori").value;
      const r1Raw = document.getElementById("d-range1").value;
      const r2Raw = document.getElementById("d-range2").value;
      const r3Raw = document.getElementById("d-range3").value;
      const r4Raw = document.getElementById("d-range4").value;

      if(!key || Number.isNaN(fondi) || Number.isNaN(bisogno) || fondi<0 || bisogno<0){
        alert("Please fill in the fields correctly."); return;
      }
      const donDisp = donRaw.split(",").map(s=>s.trim()).filter(Boolean);
      const donKeys = Array.from(new Set(donDisp.map(s=>s.trim().toLowerCase()).filter(Boolean)));

      let r1,r2,r3,r4;
      try{
        r1=parseRange(r1Raw); r2=parseRange(r2Raw); r3=parseRange(r3Raw); r4=parseRange(r4Raw);
      }catch(e){ alert(e.message); return; }

      D.elementi[key] = {
        displayName:nomeRaw.trim(), fondi, bisogno,
        possibili_donatori:donKeys, possibili_donatori_display:donDisp,
        range1:r1, range2:r2, range3:r3, range4:r4
      };
      document.getElementById("form-add").reset();
      renderDemoTable();
    });

    document.getElementById("d-clear").addEventListener("click", () => {
      if(confirm("Remove all items?")){ D.elementi = {}; renderDemoTable(); }
    });

    document.getElementById("d-calc").addEventListener("click", () => {
      const k = parseInt(document.getElementById("d-k").value,10);
      if(Number.isNaN(k) || k<1 || k>3){ alert("Set k between 1 and 3."); return; }
      const out = document.getElementById("d-result");
      out.textContent = "Calculating...";
      const esito = trovaSottoinsieme(D.elementi, k);
      if(!esito){ out.textContent = "No valid subset found."; return; }
      const { combo, risultato } = esito;
      let txt = `Subset: ${combo.map(k=>D.elementi[k].displayName).join(", ")}\n\n--- Details ---\n`;
      for(const [p, alloc] of Object.entries(risultato)){
        txt += `${D.elementi[p].displayName}:\n`;
        for(const [d, val] of alloc) txt += `  ${D.elementi[d].displayName} -> ${val}\n`;
      }
      out.textContent = txt;
    });

    renderDemoTable();

    // ===== Stripe Checkout =====
    let STRIPE_PK = "";
    (async()=>{ try{ const r=await fetch("/api/public-config"); if(r.ok){ const j=await r.json(); STRIPE_PK=j.stripePk||""; } }catch{} })();

    document.getElementById("btn-buy").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const pkg = document.getElementById("pkg").value;
      const msg = document.getElementById("msg");
      if (!email) { msg.textContent = "Enter a valid email."; return; }
      msg.textContent = "Creating checkout session...";
      try {
        const r = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // promo code field removed; not sent
          body: JSON.stringify({ email, pkg })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error?.message || "Stripe error");
        const stripe = Stripe(STRIPE_PK || "pk_test_placeholder");
        await stripe.redirectToCheckout({ sessionId: j.id });
      } catch (e) {
        msg.textContent = "Error: " + (e?.message || String(e));
      }
    });
  </script>
</body>
</html>
