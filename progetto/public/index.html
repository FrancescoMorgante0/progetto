<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>McKinsey's ecosystem game solver – Demo & Purchase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/styles.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <!-- correct file name (underscore) -->
  <script defer src="/public/js/calc_core.js"></script>
</head>
<body>
  <main class="container">
    <div class="row" style="align-items:center; justify-content:space-between; margin-bottom: 6px;">
      <h1>Ecosystem Game Solver</h1>
      <span class="badge" title="Demo does not consume attempts">Demo (k ≤ 3)</span>
    </div>
    <p class="muted">
      Try the demo (maximum subset size k = 3). If you like it, you can purchase the full solver.
      You'll receive your personal link via email and your attempts will be saved persistently.
      One attempt is consumed each time you click “Calculate”.
    </p>

    <section class="grid" style="margin-top:14px">
      <!-- DEMO (k ≤ 3, does not consume) -->
      <section class="card">
        <h2>Calculator demo</h2>

        <form id="form-add" onsubmit="return false;">
          <div class="row">
            <div class="grow">
              <label>Name</label>
              <input class="input" type="text" id="d-nome" placeholder="e.g. Eagle" />
            </div>
            <div style="width:180px">
              <label>Calories available</label>
              <input class="input" type="number" id="d-fondi" min="0" placeholder="120" />
            </div>
            <div style="width:180px">
              <label>Calories needed</label>
              <input class="input" type="number" id="d-bisogno" min="0" placeholder="200" />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label>Donors who can feed the animal (comma‑separated)</label>
              <input class="input" type="text" id="d-donatori" placeholder="Shark, Lion" />
            </div>
            <div class="grow">
              <label>Range 1 (optional, e.g. temperature)</label>
              <input class="input" type="text" id="d-range1" placeholder="1-5 or 3" />
            </div>
            <div class="grow">
              <label>Range 2 (optional)</label>
              <input class="input" type="text" id="d-range2" placeholder="10-20 or 12" />
            </div>
            <div class="grow">
              <label>Range 3 (optional)</label>
              <input class="input" type="text" id="d-range3" placeholder="2-4 or 3" />
            </div>
            <div class="grow">
              <label>Range 4 (optional)</label>
              <input class="input" type="text" id="d-range4" placeholder="5-8 or 6" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="d-add" type="button" class="btn">Add item</button>
            <button id="d-clear" type="button" class="btn btn-danger">Remove all</button>
          </div>
        </form>

        <table class="table">
          <thead>
            <tr>
              <th>Name</th><th>Calories</th><th>Required</th><th>Donors</th>
              <th>R1</th><th>R2</th><th>R3</th><th>R4</th><th></th>
            </tr>
          </thead>
          <tbody id="d-tbody"></tbody>
        </table>

        <div class="row" style="margin-top:10px; align-items: center;">
          <div style="width:260px; max-width: 100%;">
            <label>Subset k (max 3 — no limit in the full solver)</label>
            <input class="input" type="number" id="d-k" min="1" max="3" value="3" />
          </div>
          <button id="d-calc" type="button" class="btn">Calculate</button>
        </div>
        <!-- Barra di stato/progresso -->
        <div id="d-progress" style="margin-top:10px; display:none;">
          <div style="background:#e5e7eb; border-radius:8px; height:14px; width:100%; overflow:hidden;">
            <div id="d-progress-bar" style="height:100%; width:0; background:#0ea5e9; border-radius:8px; transition:width 0.6s;"></div>
          </div>
          <p class="helper" style="margin:4px 0 0; font-size:13px; color:#64748b;">Calculating... Please wait.</p>
        </div>
        <pre id="d-result" class="result" style="margin-top:10px">Add some items and press Calculate.</pre>
        <p class="helper" style="margin-top:6px">
          The demo does not consume attempts and does not require a specific link.
          The developers of this solver have no affiliation with McKinsey & Company. Use this solver in accordance with McKinsey’s policies.
        </p>
      </section>

      <!-- PURCHASE -->
      <aside class="card">
        <h2>Purchase the full calculator</h2>
        <p class="helper">Link via email, persistent attempts, no limit on subset k.</p>
        <div class="divider"></div>
        <ul class="helper" style="list-style:none; padding:0; margin:0 0 6px">
          <li>1 attempt — €30</li>
          <li>3 attempts — €50</li>
          <li>10 attempts — €100</li>
        </ul>

        <form id="buy-form" onsubmit="return false;" style="margin-top:8px">
          <label>Email</label>
          <input class="input" type="email" id="email" placeholder="name@example.com" required />

          <label>Package</label>
          <select class="select" id="pkg" required>
            <option value="1">1 attempt (€30)</option>
            <option value="3">3 attempts (€50)</option>
            <option value="10">10 attempts (€100)</option>
          </select>
          <p class="helper" style="margin-top:6px">
            If you have a discount code, you’ll be able to enter it during checkout.
          </p>
          <p class="helper" style="margin-top:6px">
            It might be possible to pay in usd.
          </p>
          <p class="helper" style="margin-top:6px">
            For best efficiency we recommend buying multiple attemps and manually divide the animals in group of ranges in temperature/location etc.
          </p>

          <button id="btn-buy" type="button" class="btn" style="margin-top:10px; width:100%">Proceed to payment</button>
          <p id="msg" class="helper" style="margin-top:8px" aria-live="polite"></p>
        </form>
      </aside>
    </section>
  </main>

  <script>
    // ===== DEMO (does not consume; k ≤ 3) =====
    const D = { elementi: {}, norm: s=>String(s||"").trim().toLowerCase(), esc: s=>escapeHtml(s) };
    const fmtRange = (r) => formatRange(r);

    function renderDemoTable(){
      const tb = document.getElementById("d-tbody");
      tb.innerHTML = "";
      const entries = Object.entries(D.elementi);
      if(entries.length===0){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=9; td.textContent="No items."; td.className="helper";
        tr.appendChild(td); tb.appendChild(tr); return;
      }
      for(const [key,data] of entries){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${D.esc(data.displayName)}</td>
          <td>${data.fondi}</td>
          <td>${data.bisogno}</td>
          <td>${(data.possibili_donatori_display||[]).map(D.esc).join(", ")}</td>
          <td>${fmtRange(data.range1)}</td>
          <td>${fmtRange(data.range2)}</td>
          <td>${fmtRange(data.range3)}</td>
          <td>${fmtRange(data.range4)}</td>
          <td></td>`;
        const tdAz=tr.lastElementChild;
        const b=document.createElement("button");
        b.textContent="Remove";
        b.className="btn btn-danger";
        b.onclick=()=>{ delete D.elementi[key]; renderDemoTable(); };
        tdAz.appendChild(b);
        tb.appendChild(tr);
      }
    }

    document.getElementById("d-add").addEventListener("click", () => {
      const nomeRaw = document.getElementById("d-nome").value;
      const key = D.norm(nomeRaw);
      const fondi = parseInt((document.getElementById("d-fondi").value || "0"),10);
      const bisogno = parseInt((document.getElementById("d-bisogno").value || "0"),10);
      const donRaw = document.getElementById("d-donatori").value;
      const r1Raw = document.getElementById("d-range1").value;
      const r2Raw = document.getElementById("d-range2").value;
      const r3Raw = document.getElementById("d-range3").value;
      const r4Raw = document.getElementById("d-range4").value;

      if(!key || Number.isNaN(fondi) || Number.isNaN(bisogno) || fondi<0 || bisogno<0){
        alert("Please fill in the fields correctly."); return;
      }
      const donDisp = donRaw.split(",").map(s=>s.trim()).filter(Boolean);
      const donKeys = Array.from(new Set(donDisp.map(s=>s.trim().toLowerCase()).filter(Boolean)));

      let r1,r2,r3,r4;
      try{
        r1=parseRange(r1Raw); r2=parseRange(r2Raw); r3=parseRange(r3Raw); r4=parseRange(r4Raw);
      }catch(e){ alert(e.message); return; }

      D.elementi[key] = {
        displayName:nomeRaw.trim(), fondi, bisogno,
        possibili_donatori:donKeys, possibili_donatori_display:donDisp,
        range1:r1, range2:r2, range3:r3, range4:r4
      };
      document.getElementById("form-add").reset();
      renderDemoTable();
    });

    document.getElementById("d-clear").addEventListener("click", () => {
      if(confirm("Remove all items?")){ D.elementi = {}; renderDemoTable(); }
    });

    document.getElementById("d-calc").addEventListener("click", () => {
      const k = parseInt(document.getElementById("d-k").value,10);
      if(Number.isNaN(k) || k<1 || k>3){ alert("Set k between 1 and 3."); return; }
      const out = document.getElementById("d-result");
      const progress = document.getElementById("d-progress");
      const progressBar = document.getElementById("d-progress-bar");
      // Mostra barra e resetta risultato
      out.textContent = "";
      progress.style.display = "";
      progressBar.style.width = "0";

      // Animazione barra (finta, 1s)
      setTimeout(() => { progressBar.style.width = "70%"; }, 80);
      setTimeout(() => { progressBar.style.width = "100%"; }, 700);

      // Simula un piccolo delay di calcolo (es. 1s), poi mostra il risultato vero
      setTimeout(() => {
        const esito = trovaSottoinsieme(D.elementi, k);
        progress.style.display = "none";
        if(!esito){ out.textContent = "No valid subset found."; return; }
        const { combo, risultato } = esito;
        let txt = `Subset: ${combo.map(k=>D.elementi[k].displayName).join(", ")}\n\n--- Details ---\n`;
        for(const [p, alloc] of Object.entries(risultato)){
          txt += `${D.elementi[p].displayName}:\n`;
          for(const [d, val] of alloc) txt += `  ${D.elementi[d].displayName} -> ${val}\n`;
        }
        out.textContent = txt;
      }, 1000); // 1 secondo di barra animata
    });

    renderDemoTable();

    // ===== Stripe Checkout =====
    let STRIPE_PK = "";
    (async()=>{ try{ const r=await fetch("/api/public-config"); if(r.ok){ const j=await r.json(); STRIPE_PK=j.stripePk||""; } }catch{} })();

    document.getElementById("btn-buy").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const pkg = document.getElementById("pkg").value;
      const msg = document.getElementById("msg");
      if (!email) { msg.textContent = "Enter a valid email."; return; }
      msg.textContent = "Creating checkout session...";
      try {
        const r = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // promo code field removed; not sent
          body: JSON.stringify({ email, pkg })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error?.message || "Stripe error");
        const stripe = Stripe(STRIPE_PK || "pk_test_placeholder");
        await stripe.redirectToCheckout({ sessionId: j.id });
      } catch (e) {
        msg.textContent = "Error: " + (e?.message || String(e));
      }
    });
  </script>
</body>
</html>
