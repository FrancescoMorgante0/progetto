<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>McKinsey's ecosystem game solver – Personal link</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/styles.css" />
  <!-- correct file name (underscore) -->
  <script defer src="/public/js/calc_core.js"></script>
</head>
<body>
  <main class="container">
    <h1>Ecosystem Game Solver</h1>

    <section class="card">
      <div class="row" style="align-items:center">
        <div>Token: <span id="tok" class="badge">—</span></div>
        <div style="margin-left:10px">Remaining attempts: <strong id="tentativi">—</strong></div>
        <div id="netmsg" class="muted" style="margin-left:10px"></div>
      </div>
    </section>

    <section class="card">
      <h2>Add item</h2>
      <form id="form-add" onsubmit="return false;">
        <div class="row">
          <div class="grow">
            <label>Name</label>
            <input class="input" type="text" id="nome" placeholder="e.g. Eagle" />
          </div>
          <div style="width:180px">
            <label>Calories available</label>
            <input class="input" type="number" id="fondi" min="0" placeholder="120" />
            <p class="helper">If empty, it defaults to 0.</p>
          </div>
          <div style="width:180px">
            <label>Calories needed</label>
            <input class="input" type="number" id="bisogno" min="0" placeholder="200" />
            <p class="helper">If empty, it defaults to 0.</p>
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label>Donors who can feed the animal (comma‑separated)</label>
            <input class="input" type="text" id="donatori" placeholder="Shark, Lion" />
          </div>
          <div class="grow">
            <label>Range 1 (optional, e.g. temperature)</label>
            <input class="input" type="text" id="range1" placeholder="1-5 or 3" />
          </div>
          <div class="grow">
            <label>Range 2 (optional)</label>
            <input class="input" type="text" id="range2" placeholder="10-20 or 12" />
          </div>
          <div class="grow">
            <label>Range 3 (optional)</label>
            <input class="input" type="text" id="range3" placeholder="2-4 or 3" />
          </div>
          <div class="grow">
            <label>Range 4 (optional)</label>
            <input class="input" type="text" id="range4" placeholder="5-8 or 6" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btn-add" type="button" class="btn">Add item</button>
          <button id="btn-clear" type="button" class="btn btn-danger">Remove all</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Subset calculation</h2>
      <div class="row" style="align-items:center">
        <div style="width:160px">
          <label>k</label>
          <input class="input" type="number" id="k" min="1" />
        </div>
        <button id="btn-calc" type="button" class="btn">Calculate</button>
      </div>
      <pre id="result" class="result" style="margin-top:10px"></pre>
    </section>
  </main>

  <script>
    const API = { attempts: "/api/attempts" };

    const token = new URLSearchParams(location.search).get("t") || "";
    const elTok = document.getElementById("tok");
    const elTentativi = document.getElementById("tentativi");
    const elTbody = document.getElementById("tbody");
    const elResult = document.getElementById("result");
    const netMsg = document.getElementById("netmsg");
    const btnCalc = document.getElementById("btn-calc");

    elTok.textContent = token || "—";
    if (!token) {
      netMsg.textContent = "Open this page from the link you received via email (missing token).";
      btnCalc.disabled = true;
    }

    const elementi = {};
    const normalizeName = (s) => String(s || "").trim().toLowerCase();
    const getDisplayName = (k) => elementi[k]?.displayName || k;

    async function attempts(action){
      if(!token) throw new Error("Missing token. Use a valid link.");
      const res = await fetch(API.attempts, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action, token })
      });
      if(!res.ok){
        let msg='API error'; try{ const j=await res.json(); msg=j.error||msg; }catch{}
        throw new Error(msg);
      }
      return res.json(); // { remaining }
    }

    async function refreshAttempts(){
      try{
        const { remaining } = await attempts('status');
        elTentativi.textContent = remaining;
        btnCalc.disabled = remaining <= 0;
        netMsg.textContent = '';
      }catch(e){
        elTentativi.textContent = '—';
        btnCalc.disabled = true;
        netMsg.textContent = e.message;
      }
    }

    function renderTabella(){
      // create table body lazily if missing
      let tbody = elTbody;
      if (!tbody) {
        const tblSection = document.querySelector("section.card:nth-of-type(2)");
        const table = document.createElement("table");
        table.className = "table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th><th>Calories</th><th>Required</th><th>Donors</th>
              <th>R1</th><th>R2</th><th>R3</th><th>R4</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>`;
        tblSection.appendChild(table);
        tbody = document.getElementById("tbody");
      }

      tbody.innerHTML = "";
      const entries = Object.entries(elementi);
      if(entries.length===0){
        const tr=document.createElement("tr"); const td=document.createElement("td");
        td.colSpan=9; td.textContent="No items added."; td.className="helper";
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      for(const [key,data] of entries){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(data.displayName)}</td>
          <td>${data.fondi}</td>
          <td>${data.bisogno}</td>
          <td>${(data.possibili_donatori_display||[]).map(escapeHtml).join(", ")}</td>
          <td>${formatRange(data.range1)}</td>
          <td>${formatRange(data.range2)}</td>
          <td>${formatRange(data.range3)}</td>
          <td>${formatRange(data.range4)}</td>
          <td></td>`;
        const tdAzioni=tr.lastElementChild;
        const btnDel=document.createElement("button");
        btnDel.textContent="Remove";
        btnDel.className="btn btn-danger";
        btnDel.onclick=()=>{ delete elementi[key]; renderTabella(); };
        tdAzioni.appendChild(btnDel);
        tbody.appendChild(tr);
      }
    }

    document.getElementById("btn-add").addEventListener("click", () => {
      const nomeRaw = document.getElementById("nome").value;
      const nomeKey = normalizeName(nomeRaw);
      const fondi = parseInt((document.getElementById("fondi").value || "0"),10);
      const bisogno = parseInt((document.getElementById("bisogno").value || "0"),10);
      const donatoriRaw = document.getElementById("donatori").value;
      const range1Raw = document.getElementById("range1").value;
      const range2Raw = document.getElementById("range2").value;
      const range3Raw = document.getElementById("range3").value;
      const range4Raw = document.getElementById("range4").value;

      if(!nomeKey || Number.isNaN(fondi) || Number.isNaN(bisogno) || fondi<0 || bisogno<0){
        alert("Please fill in the fields correctly (Name not empty, Calories/Required integers ≥ 0)."); return;
      }
      const donDisp = donatoriRaw.split(",").map(s=>s.trim()).filter(Boolean);
      const donKeys = Array.from(new Set(donDisp.map(s => s.trim().toLowerCase()).filter(Boolean)));

      let r1,r2,r3,r4;
      try{
        r1=parseRange(range1Raw);
        r2=parseRange(range2Raw);
        r3=parseRange(range3Raw);
        r4=parseRange(range4Raw);
      }catch(e){ alert(e.message); return; }

      elementi[nomeKey] = {
        displayName:nomeRaw.trim(), fondi, bisogno,
        possibili_donatori:donKeys, possibili_donatori_display:donDisp,
        range1:r1, range2:r2, range3:r3, range4:r4
      };
      document.getElementById("form-add").reset();
      renderTabella();
    });

    document.getElementById("btn-clear").addEventListener("click", () => {
      if(!confirm("Are you sure you want to remove all items?")) return;
      for(const k of Object.keys(elementi)) delete elementi[k];
      renderTabella();
    });

    document.getElementById("btn-calc").addEventListener("click", async () => {
      try{
        const kVal = parseInt(document.getElementById("k").value,10);
        if(Number.isNaN(kVal) || kVal<1){ alert("Enter a positive integer for k."); return; }

        elResult.textContent = "Checking attempts...";
        const { remaining } = await attempts('consume'); // consume 1 attempt on server
        elTentativi.textContent = remaining;
        btnCalc.disabled = remaining <= 0;

        elResult.textContent = "Calculating...";
        const esito = trovaSottoinsieme(elementi, kVal);
        if(esito){
          const { combo, risultato } = esito;
          let text = `Found a valid subset: ${combo.map(k => getDisplayName(k)).join(", ")}\n\n`;
          text += "--- Contribution details ---\n";
          for(const [personaKey, allocazioni] of Object.entries(risultato)){
            text += `${getDisplayName(personaKey)}:\n`;
            for(const [donatoreKey, importo] of allocazioni){
              text += `  ${getDisplayName(donatoreKey)} gave ${importo}\n`;
            }
          }
          elResult.textContent = text;
        } else {
          elResult.textContent = "No valid subset found (range constraints or needs not satisfied).";
        }
      }catch(e){
        elResult.textContent = `Error: ${e.message}`;
      }
    });

    // Init
    renderTabella();
    refreshAttempts();
    elResult.textContent = token ? "Add items and press Calculate." : "Missing token. Use a valid link.";
  </script>
</body>
</html>
